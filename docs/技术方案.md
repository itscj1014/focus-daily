# Focus-Daily 技术方案文档

## 项目概述

**项目名称**: Focus-Daily  
**项目类型**: 跨平台应用  
**目标平台**: 
- **主要平台**: Windows 10+、macOS 11+、Linux (Ubuntu 18.04+)
- **扩展平台**: iOS 15.0+、Android API 21+  
**开发框架**: Flutter 3.24+  
**开发语言**: Dart 3.0+  
**开发策略**: 桌面优先，移动端适配

Focus-Daily是一款基于科学专注理论的时间管理应用，采用90分钟专注+20分钟休息的主周期，配合3-5分钟随机微休息机制，帮助用户提高专注力和工作效率。

## 开发策略

### 桌面优先开发
采用桌面优先的开发策略，具有以下优势：

1. **快速开发调试**: 桌面环境开发效率更高，调试更便捷
2. **功能验证**: 先在桌面环境验证核心功能逻辑
3. **UI设计**: 大屏幕便于UI设计和交互测试
4. **性能测试**: 桌面环境更容易进行性能分析
5. **渐进适配**: 功能稳定后再适配移动端

### 开发阶段规划
1. **Phase 1**: 桌面应用开发 (Windows/macOS/Linux)
2. **Phase 2**: 移动端适配 (iOS/Android)
3. **Phase 3**: 跨平台优化和发布

## 技术选型分析

### 框架选择：Flutter

#### 选择理由
1. **跨平台优势**: 单一代码库支持桌面和移动平台
2. **桌面支持成熟**: Flutter 3.x对桌面平台支持已趋于稳定
3. **开发效率**: Hot Reload功能，桌面调试快速便捷
4. **性能优越**: 编译到原生代码，桌面性能优异
5. **UI一致性**: 跨平台UI一致性，便于后续移动端适配
6. **生态丰富**: 桌面相关插件生态日趋完善

#### 桌面开发优势
| 优势项 | 桌面开发 | 移动开发 | 说明 |
|--------|----------|----------|------|
| 开发调试 | 快速便捷 | 需要模拟器 | 桌面直接运行，调试效率高 |
| 屏幕空间 | 大屏幕设计 | 小屏限制 | 便于UI设计和布局调试 |
| 性能分析 | 工具丰富 | 相对复杂 | 桌面性能分析工具更完善 |
| 文件访问 | 权限宽松 | 权限严格 | 桌面文件操作更灵活 |
| 测试效率 | 即时测试 | 安装部署 | 桌面可直接运行测试 |

## 核心技术栈

### 开发框架
- **Flutter**: 3.24+ (稳定版本)
- **Dart**: 3.0+ (编程语言)
- **Flutter Desktop**: 桌面平台支持

### 桌面特定依赖
- **window_manager**: 窗口管理 (大小、位置、置顶等)
- **system_tray**: 系统托盘支持
- **desktop_notifications**: 桌面通知
- **hotkey_manager**: 全局快捷键支持
- **screen_retriever**: 屏幕信息获取
- **launch_at_startup**: 开机自启动

### 状态管理
- **Riverpod 2.0**: 类型安全的状态管理解决方案
  - 编译时错误检查
  - 优秀的性能表现
  - 测试友好
  - 代码生成支持

### 架构模式
- **Clean Architecture**: 清晰的分层架构
- **MVVM**: Model-View-ViewModel设计模式
- **依赖注入**: 基于Riverpod的DI容器

## UI设计方案

### Material Design 3 + 桌面适配
采用Google最新的Material You设计系统，并进行桌面适配

#### 桌面UI特性
1. **窗口管理**: 支持窗口大小调整、最小化、置顶等
2. **菜单栏**: 传统桌面应用菜单栏设计
3. **系统托盘**: 最小化到系统托盘
4. **键盘快捷键**: 桌面应用标准快捷键
5. **右键菜单**: 上下文菜单支持
6. **拖拽操作**: 文件拖拽等桌面交互

#### UI组件库
- **flutter/material**: 核心Material Design组件
- **material_color_utilities**: 动态颜色生成
- **dynamic_color**: Material You动态主题
- **flutter_screenutil**: 屏幕适配解决方案
- **animations**: 流畅动画效果
- **lottie**: 微动画和交互效果
- **google_fonts**: Google字体支持
- **bitsdojo_window**: 自定义窗口标题栏

### 桌面UI设计原则
1. **桌面原生体验**: 符合操作系统UI规范
2. **响应式布局**: 适配不同屏幕尺寸和窗口大小
3. **键盘友好**: 完整的键盘导航支持
4. **视觉层次**: 合理的信息层次和视觉重点
5. **高效操作**: 减少鼠标移动距离，提高操作效率

## 桌面功能增强

### 1. 窗口管理
#### 功能特性
- 窗口大小记忆
- 多屏幕支持
- 窗口置顶选项
- 最小化到托盘
- 自定义窗口标题栏

#### 技术实现
- **window_manager**: 窗口管理核心
- **screen_retriever**: 多屏幕适配
- **bitsdojo_window**: 自定义标题栏

### 2. 系统集成
#### 功能特性
- 系统托盘图标
- 开机自启动
- 全局快捷键
- 桌面通知
- 系统主题跟随

#### 技术实现
- **system_tray**: 系统托盘
- **launch_at_startup**: 自启动管理
- **hotkey_manager**: 快捷键绑定
- **desktop_notifications**: 桌面通知

### 3. 文件管理
#### 功能特性
- 设置文件导入/导出
- 音频文件管理
- 数据备份/恢复
- 拖拽文件支持

#### 技术实现
- **file_picker**: 文件选择器
- **path_provider**: 文件路径管理
- **desktop_drop**: 拖拽文件支持

## 数据存储方案

### SQLite本地存储
采用SQLite作为本地数据库解决方案，完全兼容桌面平台

#### 技术栈
- **sqflite_common_ffi**: 桌面SQLite支持
- **sqflite**: 移动端SQLite支持  
- **path**: 文件路径处理
- **json_annotation**: JSON序列化注解
- **json_serializable**: JSON序列化代码生成

#### 桌面存储位置
- **Windows**: `%APPDATA%/focus_daily/`
- **macOS**: `~/Library/Application Support/focus_daily/`
- **Linux**: `~/.local/share/focus_daily/`

#### 数据库设计

##### 专注会话表 (focus_sessions)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| start_time | TEXT | 开始时间 |
| end_time | TEXT | 结束时间 |
| focus_duration | INTEGER | 专注时长(秒) |
| break_duration | INTEGER | 休息时长(秒) |
| micro_breaks_count | INTEGER | 微休息次数 |
| completed | BOOLEAN | 是否完成 |
| created_at | TEXT | 创建时间 |

##### 用户设置表 (user_settings)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| key | TEXT | 设置键名(主键) |
| value | TEXT | 设置值 |
| updated_at | TEXT | 更新时间 |

##### 音频配置表 (audio_configs)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| audio_type | TEXT | 音频类型 |
| file_path | TEXT | 文件路径 |
| is_default | BOOLEAN | 是否默认 |
| created_at | TEXT | 创建时间 |

#### 数据访问层设计
1. **Repository Pattern**: 数据仓储模式
2. **数据模型**: 使用Dart类定义数据结构
3. **序列化**: JSON自动序列化/反序列化
4. **缓存策略**: 合理的数据缓存机制

## 核心功能模块

### 1. 定时器系统
#### 桌面特性增强
- 全局快捷键控制 (开始/暂停/重置)
- 系统托盘状态显示
- 桌面通知提醒
- 窗口置顶选项
- 屏保防护

#### 技术实现
- **Timer**: Dart原生定时器 (桌面环境更稳定)
- **hotkey_manager**: 全局快捷键
- **desktop_notifications**: 桌面通知
- **wakelock_plus**: 防止系统休眠
- **window_manager**: 窗口置顶

### 2. 音频系统
#### 桌面特性
- 系统音量控制集成
- 音频设备选择
- 音频文件拖拽导入
- 音效预览播放

#### 技术实现
- **audioplayers**: 音频播放引擎 (桌面支持良好)
- **file_picker**: 音频文件选择
- **desktop_drop**: 拖拽音频文件
- **volume_controller**: 系统音量控制

### 3. 桌面通知系统
#### 功能特性
- 原生桌面通知
- 通知点击交互
- 通知历史记录
- 免打扰模式

#### 技术实现
- **desktop_notifications**: 桌面原生通知
- **system_tray**: 托盘通知
- **local_notifier**: 跨平台通知

### 4. 设置管理
#### 功能特性
- 时间参数配置
- 音频选择设置
- 主题偏好设置
- 数据导入/导出

#### 技术实现
- **shared_preferences**: 简单配置存储
- **file_picker**: 文件选择器
- **share_plus**: 数据分享功能

### 5. 数据统计
#### 功能特性
- 专注时长统计
- 完成周期记录
- 趋势分析图表
- 成就系统

#### 技术实现
- **fl_chart**: 图表绘制
- **intl**: 国际化和日期格式化
- **collection**: 数据处理工具

## 项目架构设计

### 分层架构
```
┌─────────────────────────────────────┐
│         Presentation Layer          │  ← UI层：页面、组件、状态管理
├─────────────────────────────────────┤
│           Domain Layer              │  ← 领域层：业务逻辑、用例、实体
├─────────────────────────────────────┤
│            Data Layer               │  ← 数据层：仓储、数据源、模型
├─────────────────────────────────────┤
│           Service Layer             │  ← 服务层：外部服务、工具类
└─────────────────────────────────────┘
```

### 目录结构
```
lib/
├── core/                    # 核心层
│   ├── constants/          # 常量定义
│   ├── database/          # 数据库配置
│   ├── error/             # 错误处理
│   ├── network/           # 网络配置
│   └── utils/             # 工具类
├── data/                   # 数据层
│   ├── datasources/       # 数据源
│   ├── models/           # 数据模型
│   └── repositories/     # 仓储实现
├── domain/                 # 领域层
│   ├── entities/         # 实体
│   ├── repositories/     # 仓储接口
│   └── usecases/        # 用例
├── presentation/           # 表现层
│   ├── pages/           # 页面
│   ├── widgets/        # 自定义组件
│   ├── providers/      # Riverpod状态提供者
│   └── theme/         # 主题配置
├── services/              # 服务层
│   ├── audio_service.dart
│   ├── timer_service.dart
│   ├── database_service.dart
│   └── notification_service.dart
└── main.dart              # 应用入口
```

### 依赖关系
- **Presentation** → **Domain** → **Data**
- **Services** ← → **Domain**
- **Core** ← 所有层

## 状态管理方案

### Riverpod 2.0架构
#### Provider类型选择
1. **StateProvider**: 简单状态管理
2. **StateNotifierProvider**: 复杂状态逻辑
3. **FutureProvider**: 异步数据获取
4. **StreamProvider**: 流式数据监听

#### 状态设计原则
1. **不可变性**: 状态对象不可变
2. **单一职责**: 每个Provider职责单一
3. **组合优于继承**: 通过组合构建复杂状态
4. **测试友好**: 易于单元测试

## 性能优化方案

### 渲染性能
1. **Widget优化**: 使用const构造函数
2. **Builder模式**: 局部rebuild优化
3. **图片优化**: 图片压缩和缓存
4. **动画优化**: 合理使用动画效果

### 内存管理
1. **对象池**: 复用对象减少GC压力
2. **图片缓存**: 合理的图片缓存策略
3. **定时器管理**: 及时清理定时器资源
4. **监听器管理**: 避免内存泄漏

### 电池优化
1. **后台策略**: 合理的后台执行策略
2. **CPU使用**: 避免高CPU占用操作
3. **网络优化**: 减少不必要的网络请求
4. **传感器使用**: 按需使用设备传感器

## 开发环境配置

### 桌面开发环境
- **IDE**: Visual Studio Code (推荐) / Android Studio
- **Flutter SDK**: 3.24+ 稳定版，启用桌面支持
- **Dart SDK**: 3.0+
- **平台SDK**: 
  - Windows: Visual Studio 2022 Community
  - macOS: Xcode Command Line Tools
  - Linux: CMake, Ninja, pkg-config

### Flutter桌面配置
```bash
# 启用桌面支持
flutter config --enable-windows-desktop
flutter config --enable-macos-desktop  
flutter config --enable-linux-desktop

# 创建桌面项目
flutter create --platforms=windows,macos,linux focus_daily

# 运行桌面应用
flutter run -d windows    # Windows
flutter run -d macos      # macOS  
flutter run -d linux      # Linux
```

### 开发工具配置
- **VS Code插件**: 
  - Flutter
  - Dart
  - Flutter Widget Snippets
- **调试配置**: 桌面调试配置文件
- **热重载**: 桌面应用热重载支持

## 跨平台兼容性设计

### 平台检测
```dart
import 'dart:io';

class PlatformHelper {
  static bool get isDesktop => 
    Platform.isWindows || Platform.isMacOS || Platform.isLinux;
  
  static bool get isMobile => 
    Platform.isAndroid || Platform.isIOS;
    
  static bool get isWindows => Platform.isWindows;
  static bool get isMacOS => Platform.isMacOS;
  static bool get isLinux => Platform.isLinux;
}
```

### 条件依赖配置
```yaml
dependencies:
  flutter:
    sdk: flutter
  
  # 核心依赖
  riverpod: ^2.5.1
  sqflite: ^2.3.3
  
  # 桌面专用依赖
  window_manager: ^0.3.7
  system_tray: ^2.0.3
  desktop_notifications: ^0.6.3
  hotkey_manager: ^0.2.3
  
  # 条件依赖处理
  sqflite_common_ffi: ^2.3.3  # 桌面SQLite
  
  # 平台特定配置
  audioplayers: ^6.0.0
  file_picker: ^8.0.6
  path_provider: ^2.1.3
```

### UI适配策略
1. **响应式设计**: 使用LayoutBuilder适配不同屏幕
2. **组件抽象**: 平台特定组件封装
3. **交互适配**: 鼠标vs触摸交互适配
4. **导航适配**: 桌面vs移动导航模式

## 项目时间规划 (桌面优先)

### Phase 1: 桌面应用开发 (8周)

| 阶段 | 时间 | 主要工作 | 平台 |
|------|------|----------|------|
| 架构设计 | 1周 | 技术选型、桌面架构设计 | 桌面 |
| 基础框架 | 1周 | 桌面项目搭建、基础组件 | 桌面 |
| 核心功能 | 3周 | 定时器、音频、通知 (桌面版) | 桌面 |
| 桌面UI | 2周 | 桌面界面、窗口管理、托盘 | 桌面 |
| 桌面优化 | 1周 | 性能优化、桌面特性完善 | 桌面 |

### Phase 2: 移动端适配 (5周)

| 阶段 | 时间 | 主要工作 | 平台 |
|------|------|----------|------|
| 移动适配 | 2周 | UI适配、触摸交互、权限处理 | 移动 |
| 功能适配 | 2周 | 后台服务、移动通知、生命周期 | 移动 |
| 测试优化 | 1周 | 跨平台测试、性能优化 | 全平台 |

### Phase 3: 发布准备 (2周)

| 阶段 | 时间 | 主要工作 | 平台 |
|------|------|----------|------|
| 打包发布 | 1周 | 各平台打包、签名配置 | 全平台 |
| 发布上线 | 1周 | 应用商店发布、桌面分发 | 全平台 |

### 里程碑 (桌面优先)
- **M1**: 桌面技术架构确定
- **M2**: 桌面基础框架完成  
- **M3**: 桌面核心功能完成
- **M4**: 桌面应用完整可用
- **M5**: 移动端适配完成
- **M6**: 跨平台测试完成
- **M7**: 全平台发布上线

## 桌面发布方案

### Windows发布
1. **MSIX包**: Windows 10/11应用商店发布
2. **安装程序**: Inno Setup / NSIS 安装包
3. **便携版**: 免安装绿色版本
4. **自动更新**: 应用内更新机制

### macOS发布  
1. **App Store**: Mac App Store发布
2. **DMG安装包**: 独立分发包
3. **公证签名**: Apple公证和代码签名
4. **Homebrew**: 命令行安装支持

### Linux发布
1. **AppImage**: 通用Linux应用格式
2. **Snap**: Ubuntu Snap Store
3. **Flatpak**: Flathub应用商店  
4. **deb/rpm**: 系统包管理器

## 总结

本技术方案采用**桌面优先**的开发策略，使用Flutter作为主要开发框架，具有以下优势：

1. **开发效率**: 桌面环境开发调试效率更高
2. **功能验证**: 在桌面环境快速验证核心功能
3. **技术先进性**: 采用当前主流的Flutter跨平台技术
4. **架构合理性**: 清晰的分层架构，支持后续移动端扩展
5. **用户体验**: Material Design 3提供现代化界面体验
6. **一次开发**: 单一代码库支持全平台，开发效率极高

该方案能够满足Focus-Daily项目的所有功能需求，通过桌面优先策略确保快速开发和稳定的功能基础，为后续移动端适配和长期发展奠定坚实基础。 